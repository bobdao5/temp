import{r as x}from"./@pushprotocol-794f3f69.js";import{r as N}from"./util-71d63381.js";import{r as $}from"./url-da025ee8.js";var h={},O;function H(){if(O)return h;O=1,Object.defineProperty(h,"__esModule",{value:!0}),h.InvalidStatusCodeError=h.InvalidCertError=void 0;const T=Object.freeze({redirect:!0,expectStatusCode:200,headers:{},full:!1,keepAlive:!0,cors:!1,referrer:!1,sslAllowSelfSigned:!1,_redirectCount:0});class y extends Error{constructor(r,e){super(r),this.fingerprint256=e}}h.InvalidCertError=y;class v extends Error{constructor(r){super(`Request Failed. Status Code: ${r}`),this.statusCode=r}}h.InvalidStatusCodeError=v;function R(t,r){if(!r||r==="text"||r==="json")try{let e=new TextDecoder("utf8",{fatal:!0}).decode(t);if(r==="text")return e;try{return JSON.parse(e)}catch(f){if(r==="json")throw f;return e}}catch(e){if(r==="text"||r==="json")throw e}return t}let j={};function A(t,r){var L;let e={...T,...r};const f=x,u=x,l=x,{promisify:p}=N(),{resolve:w}=$(),d=!!/^https/.test(t);let s={method:e.method||"GET",headers:{"Accept-Encoding":"gzip, deflate, br"}};const b=o=>o.replace(/:| /g,"").toLowerCase();if(e.keepAlive){const o={keepAlive:!0,keepAliveMsecs:3e4,maxFreeSockets:1024,maxCachedSessions:1024},c=[d,d&&((L=e.sslPinnedCertificates)==null?void 0:L.map(C=>b(C)).sort())].join();s.agent=j[c]||(j[c]=new(d?u:f).Agent(o))}e.type==="json"&&(s.headers["Content-Type"]="application/json"),e.data&&(e.method||(s.method="POST"),s.body=e.type==="json"?JSON.stringify(e.data):e.data),s.headers={...s.headers,...e.headers},e.sslAllowSelfSigned&&(s.rejectUnauthorized=!1);const I=async o=>{const c=o.statusCode;if(e.redirect&&300<=c&&c<400&&o.headers.location){if(e._redirectCount==10)throw new Error("Request failed. Too much redirects.");return e._redirectCount+=1,await A(w(t,o.headers.location),e)}if(e.expectStatusCode&&c!==e.expectStatusCode)throw o.resume(),new v(c);let C=[];for await(const g of o)C.push(g);let i=Buffer.concat(C);const S=o.headers["content-encoding"];S==="br"&&(i=await p(l.brotliDecompress)(i)),(S==="gzip"||S==="deflate")&&(i=await p(l.unzip)(i));const m=R(i,e.type);return e.full?{headers:o.headers,status:c,body:m}:m};return new Promise((o,c)=>{var g;const C=async n=>{if(n&&n.code==="DEPTH_ZERO_SELF_SIGNED_CERT")try{await A(t,{...e,sslAllowSelfSigned:!0,sslPinnedCertificates:[]})}catch(a){a&&a.fingerprint256&&(n=new y(`Self-signed SSL certificate: ${a.fingerprint256}`,a.fingerprint256))}c(n)},i=(d?u:f).request(t,s,n=>{n.on("error",C),(async()=>{try{o(await I(n))}catch(a){c(a)}})()});i.on("error",C);const S=(g=e.sslPinnedCertificates)==null?void 0:g.map(n=>b(n)),m=n=>{var E;const a=b(((E=n.getPeerCertificate())==null?void 0:E.fingerprint256)||"");if(!(!a&&n.isSessionReused())&&!S.includes(a))return i.emit("error",new y(`Invalid SSL certificate: ${a} Expected: ${S}`,a)),i.abort()};e.sslPinnedCertificates&&i.on("socket",n=>{n.listeners("secureConnect").map(E=>(E.name||"").replace("bound ","")).includes("mfetchSecureConnect")||n.on("secureConnect",m.bind(null,n))}),e.keepAlive&&i.setNoDelay(!0),s.body&&i.write(s.body),i.end()})}const D=new Set(["Accept","Accept-Language","Content-Language","Content-Type"].map(t=>t.toLowerCase())),P=new Set(["Accept-Charset","Accept-Encoding","Access-Control-Request-Headers","Access-Control-Request-Method","Connection","Content-Length","Cookie","Cookie2","Date","DNT","Expect","Host","Keep-Alive","Origin","Referer","TE","Trailer","Transfer-Encoding","Upgrade","Via"].map(t=>t.toLowerCase()));async function _(t,r){let e={...T,...r};const f=new Headers;e.type==="json"&&f.set("Content-Type","application/json");let u=new URL(t);if(u.username){const d=btoa(`${u.username}:${u.password}`);f.set("Authorization",`Basic ${d}`),u.username="",u.password=""}t=""+u;for(let d in e.headers){const s=d.toLowerCase();(D.has(s)||e.cors&&!P.has(s))&&f.set(d,e.headers[d])}let l={headers:f,redirect:e.redirect?"follow":"manual"};e.referrer||(l.referrerPolicy="no-referrer"),e.cors&&(l.mode="cors"),e.data&&(e.method||(l.method="POST"),l.body=e.type==="json"?JSON.stringify(e.data):e.data);const p=await fetch(t,l);if(e.expectStatusCode&&p.status!==e.expectStatusCode)throw new v(p.status);const w=R(new Uint8Array(await p.arrayBuffer()),e.type);return e.full?{headers:Object.fromEntries(p.headers.entries()),status:p.status,body:w}:w}const q=!!(typeof process=="object"&&process.versions&&process.versions.node&&process.versions.v8);function F(t,r){return(q?A:_)(t,r)}return h.default=F,h}export{H as r};
