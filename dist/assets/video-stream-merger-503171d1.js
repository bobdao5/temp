import{c as v}from"./@ethereumjs-ec0ac526.js";var h={},x={get exports(){return h},set exports(l){h=l}},m;function y(){return m||(m=1,function(l,g){(function(r,u){l.exports=u()})(v,function(){return function(){var r={d:function(d,i){for(var e in i)r.o(i,e)&&!r.o(d,e)&&Object.defineProperty(d,e,{enumerable:!0,get:i[e]})},o:function(d,i){return Object.prototype.hasOwnProperty.call(d,i)},r:function(d){typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(d,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(d,"__esModule",{value:!0})}},u={};r.r(u),r.d(u,{VideoStreamMerger:function(){return _}});class _{constructor(i){this.width=720,this.height=405,this.fps=25,this._streams=[],this._frameCount=0,this.clearRect=!0,this.started=!1,this.result=null,this.supported=null,this._canvas=null,this._ctx=null,this._videoSyncDelayNode=null,this._audioDestination=null,this._audioCtx=null;const e=window.AudioContext||window.webkitAudioContext,t=!(!window.AudioContext||!new e().createMediaStreamDestination),s=!!document.createElement("canvas").captureStream;if(!(this.supported=t&&s))return;this.setOptions(i);const a=this._audioCtx=new e,o=this._audioDestination=a==null?void 0:a.createMediaStreamDestination();this._videoSyncDelayNode=a.createDelay(5),this._videoSyncDelayNode.connect(o),this._setupConstantNode(),this.started=!1,this.result=null,this._backgroundAudioHack()}setOptions(i){i=i||{},this._audioCtx=i.audioContext||new AudioContext,this.width=i.width||this.width,this.height=i.height||this.width,this.fps=i.fps||this.fps,this.clearRect=i.clearRect===void 0||i.clearRect}setOutputSize(i,e){this.width=i,this.height=e,this._canvas&&(this._canvas.setAttribute("width",this.width.toString()),this._canvas.setAttribute("height",this.height.toString()))}getAudioContext(){return this._audioCtx}getAudioDestination(){return this._audioDestination}getCanvasContext(){return this._ctx}_backgroundAudioHack(){if(this._audioCtx){const i=this._createConstantSource(),e=this._audioCtx.createGain();e&&i&&(e.gain.value=.001,i.connect(e),e.connect(this._audioCtx.destination),i.start())}}_setupConstantNode(){if(this._audioCtx&&this._videoSyncDelayNode){const i=this._createConstantSource();if(i){i.start();const e=this._audioCtx.createGain();e.gain.value=0,i.connect(e),e.connect(this._videoSyncDelayNode)}}}_createConstantSource(){if(this._audioCtx){if(this._audioCtx.createConstantSource)return this._audioCtx.createConstantSource();const i=this._audioCtx.createBufferSource(),e=this._audioCtx.createBuffer(1,1,this._audioCtx.sampleRate);return e.getChannelData(0)[0]=10,i.buffer=e,i.loop=!0,i}}updateIndex(i,e){typeof i=="string"&&(i={id:i}),e=e??0;for(let t=0;t<this._streams.length;t++)i.id===this._streams[t].id&&(this._streams[t].index=e);this._sortStreams()}_sortStreams(){this._streams=this._streams.sort((i,e)=>i.index-e.index)}addMediaElement(i,e,t){if((t=t||{}).x=t.x||0,t.y=t.y||0,t.width=t.width||this.width,t.height=t.height||this.height,t.mute=t.mute||t.muted||!1,t.oldDraw=t.draw,t.oldAudioEffect=t.audioEffect,e instanceof HTMLVideoElement||e instanceof HTMLImageElement?t.draw=(s,a,o)=>{if(t.oldDraw)t.oldDraw(s,e,o);else{const n=t.width==null?this.width:t.width,c=t.height==null?this.height:t.height;s.drawImage(e,t.x,t.y,n,c),o()}}:t.draw=null,this._audioCtx&&!t.mute){const s=e._mediaElementSource||this._audioCtx.createMediaElementSource(e);e._mediaElementSource=s,s.connect(this._audioCtx.destination);const a=this._audioCtx.createGain();s.connect(a),(e instanceof HTMLVideoElement||e instanceof HTMLAudioElement)&&e.muted?(e.muted=!1,e.volume=.001,a.gain.value=1e3):a.gain.value=1,t.audioEffect=(o,n)=>{t.oldAudioEffect?t.oldAudioEffect(a,n):a.connect(n)},t.oldAudioEffect=null}this.addStream(i,t)}addStream(i,e){if(typeof i=="string")return this._addData(i,e);e=e||{};const t={isData:!1};t.x=e.x||0,t.y=e.y||0,t.width=e.width,t.height=e.height,t.draw=e.draw||null,t.mute=e.mute||e.muted||!1,t.audioEffect=e.audioEffect||null,t.index=e.index==null?0:e.index,t.hasVideo=i.getVideoTracks().length>0,t.hasAudio=i.getAudioTracks().length>0;let s=null;for(let a=0;a<this._streams.length;a++)this._streams[a].id===i.id&&(s=this._streams[a].element);s||(s=document.createElement("video"),s.autoplay=!0,s.muted=!0,s.playsInline=!0,s.srcObject=i,s.setAttribute("style","position:fixed; left: 0px; top:0px; pointer-events: none; opacity:0;"),document.body.appendChild(s),s.play().catch(null),t.hasAudio&&this._audioCtx&&!t.mute&&(t.audioSource=this._audioCtx.createMediaStreamSource(i),t.audioOutput=this._audioCtx.createGain(),t.audioOutput.gain.value=1,t.audioEffect?t.audioEffect(t.audioSource,t.audioOutput):t.audioSource.connect(t.audioOutput),t.audioOutput.connect(this._videoSyncDelayNode))),t.element=s,t.id=i.id||null,this._streams.push(t),this._sortStreams()}removeStream(i){typeof i=="string"&&(i={id:i});for(let e=0;e<this._streams.length;e++){const t=this._streams[e];i.id===t.id&&(t.audioSource&&(t.audioSource=null),t.audioOutput&&(t.audioOutput.disconnect(this._videoSyncDelayNode),t.audioOutput=null),t.element&&t.element.remove(),this._streams[e]=null,this._streams.splice(e,1),e--)}}_addData(i,e){e=e||{};const t={isData:!0};t.draw=e.draw||null,t.audioEffect=e.audioEffect||null,t.id=i,t.element=null,t.index=e.index==null?0:e.index,this._videoSyncDelayNode&&this._audioCtx&&t.audioEffect&&(t.audioOutput=this._audioCtx.createGain(),t.audioOutput.gain.value=1,t.audioEffect(null,t.audioOutput),t.audioOutput.connect(this._videoSyncDelayNode)),this._streams.push(t),this._sortStreams()}_requestAnimationFrame(i){let e=!1;const t=setInterval(()=>{!e&&document.hidden&&(e=!0,clearInterval(t),i())},1e3/this.fps);requestAnimationFrame(()=>{e||(e=!0,clearInterval(t),i())})}start(){var i,e,t,s,a;this._canvas=document.createElement("canvas"),this._canvas.setAttribute("width",this.width.toString()),this._canvas.setAttribute("height",this.height.toString()),this._canvas.setAttribute("style","position:fixed; left: 110%; pointer-events: none"),this._ctx=this._canvas.getContext("2d"),this.started=!0,this._requestAnimationFrame(this._draw.bind(this)),this.result=((i=this._canvas)===null||i===void 0?void 0:i.captureStream(this.fps))||null;const o=(e=this.result)===null||e===void 0?void 0:e.getAudioTracks()[0];o&&((t=this.result)===null||t===void 0||t.removeTrack(o));const n=(s=this._audioDestination)===null||s===void 0?void 0:s.stream.getAudioTracks();n&&n.length&&((a=this.result)===null||a===void 0||a.addTrack(n[0]))}_updateAudioDelay(i){this._videoSyncDelayNode&&this._audioCtx&&this._videoSyncDelayNode.delayTime.setValueAtTime(i/1e3,this._audioCtx.currentTime)}_draw(){var i;if(!this.started)return;this._frameCount++;let e=0;this._frameCount%60==0&&(e=performance.now());let t=this._streams.length;const s=()=>{if(t--,t<=0){if(this._frameCount%60==0){const a=performance.now();this._updateAudioDelay(a-e)}this._requestAnimationFrame(this._draw.bind(this))}};this.clearRect&&((i=this._ctx)===null||i===void 0||i.clearRect(0,0,this.width,this.height)),this._streams.forEach(a=>{a.draw?a.draw(this._ctx,a.element,s):(!a.isData&&a.hasVideo&&this._drawVideo(a.element,a),s())}),this._streams.length===0&&s()}_drawVideo(i,e){var t;const s=this.height,a=this.width,o=e.height||s,n=e.width||a;let c=e.x||0,f=e.y||0;try{(t=this._ctx)===null||t===void 0||t.drawImage(i,c,f,n,o)}catch(p){console.error(p)}}stop(){var i,e;this.started=!1,this._canvas=null,this._ctx=null,this._streams.forEach(t=>{t.element&&t.element.remove()}),this._streams=[],(i=this._audioCtx)===null||i===void 0||i.close(),this._audioCtx=null,this._audioDestination=null,this._videoSyncDelayNode=null,(e=this.result)===null||e===void 0||e.getTracks().forEach(t=>{t.stop()}),this.result=null}destroy(){this.stop()}}return typeof window<"u"&&(window.VideoStreamMerger=_),u}()})}(x)),h}export{y as r};
